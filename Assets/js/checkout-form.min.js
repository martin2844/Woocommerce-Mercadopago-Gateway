"use strict";function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){var a,r=parseFloat(e.amount);t.setPublishableKey(e.public_key),n(document.body).on("updated_checkout",function(){r=void n.post(e.ajax_url,{action:"wc_mp_gateway_checkout_get_cart_price"},function(e,t,n){e.success&&(r=parseFloat(e.data))}),a="",new i(".wc-mp-gateway-form")}),n("form.checkout.woocommerce-checkout").on("checkout_place_order_wc_mp_gateway",function(){var t=document.querySelector(".wc-mp-gateway-form");if(c.createToken(t),!t.querySelector('input[name="CcToken"]'))return alert(e.invalid_card_error_alert),!1});var c={getBin:function(e){return e.substring(0,7)},createToken:function(e){t.clearSession(),t.createToken(e,function(t,n){if(200===t||201===t){var a=e.querySelector('input[name="CcToken"]');if(a)a.value=n.id;else{var r=document.createElement("input");r.setAttribute("name","CcToken"),r.setAttribute("type","hidden"),r.setAttribute("value",n.id),e.appendChild(r)}}})}},i=function(){function n(i){var l=this;_classCallCheck(this,n),_defineProperty(this,"showInstallmentLabel",function(){var e=l.elems.installments.selectedIndex,t=l.elems.installments.options[e].getAttribute("data-label");l.elems.installmentsRateLabel.innerHTML=t}),_defineProperty(this,"createCardToken",function(){l.ccTokenValues.number=l.elems.ccHiddenNumber.value,l.ccTokenValues.name=l.elems.ccName.value,l.ccTokenValues.month=l.elems.ccHiddenMonth.value,l.ccTokenValues.year=l.elems.ccHiddenYear.value,l.ccTokenValues.cvc=l.elems.ccCvc.value,l.ccTokenValues.document=l.elems.ccDocumentNumber.value,c.createToken(l.elems.form)}),_defineProperty(this,"checkCardToken",function(e){var t=l.elems.ccHiddenNumber.value;if(t.length<16)return!1;if(l.elems.ccName.value.length<3)return!1;var n=l.elems.ccHiddenMonth.value;if(!n)return!1;var a=l.elems.ccHiddenYear.value;if(!a)return!1;var r=l.elems.ccCvc.value;if(r.length<3)return!1;var c=l.elems.ccDocumentNumber.value;if(c.length<5)return!1;l.ccTokenValues.number===t&&l.ccTokenValues.month===n&&l.ccTokenValues.year===a&&l.ccTokenValues.cvc===r&&l.ccTokenValues.document===c||l.createCardToken()}),_defineProperty(this,"syncCcNumber",function(e){var t=e.currentTarget.value.replace(/\D/g,"");l.elems.ccHiddenNumber.value=t}),_defineProperty(this,"handleNewccNumber",function(e){var n=c.getBin(l.elems.ccNumber.value);n.length<7||a===n||(a=n,n=n.replace(/\D/g,""),t.getPaymentMethod({bin:n},l.setPaymentMethodInfo.bind(l)),t.getInstallments({bin:n,amount:r},l.setInstallmentsInfo.bind(l)))}),_defineProperty(this,"clearExpirationDate",function(){l.elems.ccHiddenMonth.value="",l.elems.ccHiddenYear.value=""}),_defineProperty(this,"setExpirationDates",function(e){var t=e.match(/[0-9]{2}/g);if(2!==t.length)return!1;l.setMonthExpirationDate(t[0]),l.setYearExpirationDate(t[1])}),_defineProperty(this,"setPaymentMethodInfo",function(e,n){200===e&&(l.elems.hiddenPaymentMethodId.value=n[0].id,t.getIdentificationTypes())}),_defineProperty(this,"setInstallmentsInfo",function(e,t){if(200===e){var n=null,a=null;for(var r in t){var c=t[r];if("gateway"===c.processing_mode){n=c;break}"aggregator"===c.processing_mode&&(a=c)}n?l.elems.hiddenInstallmentsType.value="gateway":a&&(l.elems.hiddenInstallmentsType.value="aggregator",n=a),l.setInstallments(n.payer_costs)}}),_defineProperty(this,"setInstallments",function(e){for(;l.elems.installments.options.length;)l.elems.installments.options.remove(0);e.forEach(function(e){var t=document.createElement("option"),n=e.labels.length,a=0;for(a=0;a<n;a++){if(-1!==e.labels[a].indexOf("CFT_"))break}t.text=e.recommended_message,t.setAttribute("data-label",e.labels[a]),t.setAttribute("value",e.installments),l.elems.installments.appendChild(t)})}),_defineProperty(this,"setMonthExpirationDate",function(e){l.elems.ccHiddenMonth.value=e}),_defineProperty(this,"setYearExpirationDate",function(e){l.elems.ccHiddenYear.value=e});var s=document.querySelector(i);this.elems={form:s,ccName:s.querySelector('input[name="ccName"]'),ccExpiry:s.querySelector('input[name="ccExpiry"]'),ccNumber:s.querySelector('input[name="ccNumber"]'),ccCvc:s.querySelector('input[name="ccCvc"]'),ccDocumentNumber:s.querySelector('input[name="docNumber"]'),hiddenPaymentMethodId:s.querySelector('input[name="hiddenPaymentMethodId"]'),installments:s.querySelector('select[name="installments"]'),installmentsRateLabel:s.querySelector(".installments_rate"),hiddenInstallmentsType:s.querySelector('input[name="hiddenInstallmentsType"]'),ccHiddenNumber:s.querySelector('input[name="hiddenCcNumber"]'),ccHiddenMonth:s.querySelector('input[name="hiddenExpiryMonth"]'),ccHiddenYear:s.querySelector('input[name="hiddenExpiryYear"]')},this.ccTokenValues={number:null,name:null,month:null,year:null,cvc:null,document:null},new Card({form:this.elems.form,container:".wc-mp-gateway-form-card",formSelectors:{numberInput:'input[name="ccNumber"]',expiryInput:'input[name="ccExpiry"]',cvcInput:'input[name="ccCvc"]',nameInput:'input[name="ccName"]'},width:e.card_size}),this.elems.ccNumber.addEventListener("keyup",this.handleNewccNumber.bind(this)),this.elems.ccExpiry.addEventListener("keyup",this.handleExpiryDateChange.bind(this)),this.elems.installments.addEventListener("change",this.showInstallmentLabel.bind(this)),this.elems.ccNumber.addEventListener("keyup",this.syncCcNumber.bind(this)),this.elems.form.addEventListener("keyup",this.checkCardToken.bind(this))}return _createClass(n,[{key:"handleExpiryDateChange",value:function(e){var t=e.currentTarget;t.classList.contains("jp-card-valid")?this.setExpirationDates(t.value):this.clearExpirationDate()}}]),n}()}(wc_mp_gateway_settings,Mercadopago,jQuery);