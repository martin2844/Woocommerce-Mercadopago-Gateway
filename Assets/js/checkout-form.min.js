"use strict";function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){var a=parseFloat(e.amount);t.setPublishableKey(e.public_key),n(document.body).on("updated_checkout",function(){a=void n.post(e.ajax_url,{action:"wc_mp_gateway_checkout_get_cart_price"},function(e,t,n){e.success&&(a=parseFloat(e.data))}),new c(".wc-mp-gateway-form")}),n("form.checkout.woocommerce-checkout").on("checkout_place_order_wc_mp_gateway",function(){var t=document.querySelector(".wc-mp-gateway-form");if(r.createToken(t),!t.querySelector('input[name="CcToken"]'))return alert(e.invalid_card_error_alert),!1});var r={getBin:function(e){return e.substring(0,7)},createToken:function(e){t.clearSession(),t.createToken(e,function(t,n){if(200===t||201===t){var a=e.querySelector('input[name="CcToken"]');if(a)a.value=n.id;else{var r=document.createElement("input");r.setAttribute("name","CcToken"),r.setAttribute("type","hidden"),r.setAttribute("value",n.id),e.appendChild(r)}}})}},c=function(){function n(c){var i=this;_classCallCheck(this,n),_defineProperty(this,"showInstallmentLabel",function(){var e=i.elems.installments.selectedIndex,t=i.elems.installments.options[e].getAttribute("data-label");i.elems.installmentsRateLabel.innerHTML=t}),_defineProperty(this,"createCardToken",function(){i.ccTokenValues.number=i.elems.ccHiddenNumber.value,i.ccTokenValues.name=i.elems.ccName.value,i.ccTokenValues.month=i.elems.ccHiddenMonth.value,i.ccTokenValues.year=i.elems.ccHiddenYear.value,i.ccTokenValues.cvc=i.elems.ccCvc.value,i.ccTokenValues.document=i.elems.ccDocumentNumber.value,r.createToken(i.elems.form)}),_defineProperty(this,"checkCardToken",function(e){var t=i.elems.ccHiddenNumber.value;if(t.length<16)return!1;if(i.elems.ccName.value.length<3)return!1;var n=i.elems.ccHiddenMonth.value;if(!n)return!1;var a=i.elems.ccHiddenYear.value;if(!a)return!1;var r=i.elems.ccCvc.value;if(r.length<3)return!1;var c=i.elems.ccDocumentNumber.value;if(c.length<5)return!1;i.ccTokenValues.number===t&&i.ccTokenValues.month===n&&i.ccTokenValues.year===a&&i.ccTokenValues.cvc===r&&i.ccTokenValues.document===c||i.createCardToken()}),_defineProperty(this,"syncCcNumber",function(e){var t=e.currentTarget.value.replace(/\D/g,"");i.elems.ccHiddenNumber.value=t}),_defineProperty(this,"handleNewccNumber",function(e){var n=r.getBin(i.elems.ccNumber.value);n.length<7||(n=n.replace(/\D/g,""),t.getPaymentMethod({bin:n},i.setPaymentMethodInfo.bind(i)),t.getInstallments({bin:n,amount:a},i.setInstallmentsInfo.bind(i)))}),_defineProperty(this,"clearExpirationDate",function(){i.elems.ccHiddenMonth.value="",i.elems.ccHiddenYear.value=""}),_defineProperty(this,"setExpirationDates",function(e){var t=e.match(/[0-9]{2}/g);if(2!==t.length)return!1;i.setMonthExpirationDate(t[0]),i.setYearExpirationDate(t[1])}),_defineProperty(this,"setPaymentMethodInfo",function(e,n){200===e&&(i.elems.hiddenPaymentMethodId.value=n[0].id,t.getIdentificationTypes())}),_defineProperty(this,"setInstallmentsInfo",function(e,t){if(200===e){var n=null,a=null;for(var r in t){var c=t[r];if("gateway"===c.processing_mode){n=c;break}"aggregator"===c.processing_mode&&(a=c)}n?i.elems.hiddenInstallmentsType.value="gateway":a&&(i.elems.hiddenInstallmentsType.value="aggregator",n=a),i.setInstallments(n.payer_costs)}}),_defineProperty(this,"setInstallments",function(e){for(;i.elems.installments.options.length;)i.elems.installments.options.remove(0);e.forEach(function(e){var t=document.createElement("option"),n=e.labels.length,a=0;for(a=0;a<n;a++){if(-1!==e.labels[a].indexOf("CFT_"))break}t.text=e.recommended_message,t.setAttribute("data-label",e.labels[a]),t.setAttribute("value",e.installments),i.elems.installments.appendChild(t)})}),_defineProperty(this,"setMonthExpirationDate",function(e){i.elems.ccHiddenMonth.value=e}),_defineProperty(this,"setYearExpirationDate",function(e){i.elems.ccHiddenYear.value=e});var l=document.querySelector(c);this.elems={form:l,ccName:l.querySelector('input[name="ccName"]'),ccExpiry:l.querySelector('input[name="ccExpiry"]'),ccNumber:l.querySelector('input[name="ccNumber"]'),ccCvc:l.querySelector('input[name="ccCvc"]'),ccDocumentNumber:l.querySelector('input[name="docNumber"]'),hiddenPaymentMethodId:l.querySelector('input[name="hiddenPaymentMethodId"]'),installments:l.querySelector('select[name="installments"]'),installmentsRateLabel:l.querySelector(".installments_rate"),hiddenInstallmentsType:l.querySelector('input[name="hiddenInstallmentsType"]'),ccHiddenNumber:l.querySelector('input[name="hiddenCcNumber"]'),ccHiddenMonth:l.querySelector('input[name="hiddenExpiryMonth"]'),ccHiddenYear:l.querySelector('input[name="hiddenExpiryYear"]')},this.ccTokenValues={number:null,name:null,month:null,year:null,cvc:null,document:null},new Card({form:this.elems.form,container:".wc-mp-gateway-form-card",formSelectors:{numberInput:'input[name="ccNumber"]',expiryInput:'input[name="ccExpiry"]',cvcInput:'input[name="ccCvc"]',nameInput:'input[name="ccName"]'},width:e.card_size}),this.elems.ccNumber.addEventListener("keyup",this.handleNewccNumber.bind(this)),this.elems.ccExpiry.addEventListener("keyup",this.handleExpiryDateChange.bind(this)),this.elems.installments.addEventListener("change",this.showInstallmentLabel.bind(this)),this.elems.ccNumber.addEventListener("keyup",this.syncCcNumber.bind(this)),this.elems.form.addEventListener("keyup",this.checkCardToken.bind(this))}return _createClass(n,[{key:"handleExpiryDateChange",value:function(e){var t=e.currentTarget;t.classList.contains("jp-card-valid")?this.setExpirationDates(t.value):this.clearExpirationDate()}}]),n}()}(wc_mp_gateway_settings,Mercadopago,jQuery);